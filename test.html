<h2>Générateur Autonome</h2>
<input type="text" id="prompt" value="reggae dub King tubby dela tape invasion" placeholder="Prompt">
<button onclick="generateMusic()">Générer Musique Test</button>
<div id="genResult"></div>
<audio controls id="audioGen"></audio>
<a id="downloadGen" href="" download>Download & Archive</a>

<h2>Récupérer & Archiver de Base44</h2>
<input type="text" id="trackId" value="44" placeholder="Track ID">
<button onclick="retrieveAndArchive()">Récupérer & Archiver</button>

<h2>Archive</h2>
<div class="archive" id="archive"></div>

<script>
    const API_URL = "https://undergroundstudioapp.netlify.app/generateAudio"; // Ton domaine Netlify
    const BASE44_API_URL = "https://base44.app/api/apps/688deddde15fa30e9518db74/entities/Track/"; // Ton BASE44_APP_ID
    const BASE44_API_KEY = process.env.BASE44_API_KEY || "a71b9a537cc3a41a9f3623ffd3c624e2"; // Env var ou clé test (révoque après)
    const consoleEl = document.getElementById('console');
    let archive = localStorage.getItem('archive') ? JSON.parse(localStorage.getItem('archive')) : [];

    function log(message) {
        consoleEl.innerHTML += `<p>${new Date().toLocaleTimeString()} - ${message}</p>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    async function generateMusic() {
        const prompt = document.getElementById('prompt').value;
        log("Début génération...");
        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${BASE44_API_KEY}` },
                body: JSON.stringify({ prompt, trackId: Date.now().toString(), customMode: false, instrumental: true, model: "V3_5" })
            });
            if (!response.ok) throw new Error(`Erreur: ${response.status}`);
            const data = await response.json();
            log("Succès: taskId = " + data.taskId);
            document.getElementById('audioGen').src = data.audio_url || "";
            document.getElementById('downloadGen').href = data.audio_url || "";
            archive.push({ id: data.taskId, url: data.audio_url || "", prompt });
            updateArchive();
        } catch (error) {
            log("Erreur: " + error.message);
        }
    }

    async function retrieveAndArchive() {
        const trackId = document.getElementById('trackId').value;
        log("Récupération de Base44 pour trackId: " + trackId);
        try {
            const response = await fetch(BASE44_API_URL + trackId, {
                headers: { "Authorization": `Bearer ${BASE44_API_KEY}` }
            });
            if (!response.ok) throw new Error(`Erreur récupération: ${response.status}`);
            const data = await response.json();
            log("Succès récupération: audio_url = " + data.audio_url);
            archive.push({ id: trackId, url: data.audio_url || "", prompt: data.prompt || "" });
            updateArchive();
        } catch (error) {
            log("Erreur: " + error.message);
        }
    }

    function updateArchive() {
        const archiveDiv = document.getElementById('archive');
        archiveDiv.innerHTML = archive.map(item => `
            <div>Track ${item.id} (${item.prompt})
                <audio controls src="${item.url}"></audio>
                <a href="${item.url}" download="track_${item.id}.mp3">Download & Archive</a>
            </div>
        `).join('');
        localStorage.setItem('archive', JSON.stringify(archive));
    }
    updateArchive(); // Charge archive initiale
</script>