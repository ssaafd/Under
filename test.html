<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Underground Studio - Console Matrix TV Vintage Pro</title>
    <style>
        body { background-color: black; color: lime; font-family: 'Courier New', monospace; padding: 20px; }
        .tv-frame { border: 10px solid #333; border-radius: 20px; box-shadow: 0 0 20px rgba(0,255,0,0.5); background: #111; padding: 20px; width: 90%; margin: auto; position: relative; }
        .tv-screen { background-color: #000; border: 1px solid lime; padding: 10px; height: 400px; overflow-y: scroll; font-size: 12px; box-shadow: inset 0 0 10px lime; animation: scanline 6s linear infinite, flicker 0.5s infinite; }
        @keyframes scanline { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes flicker { 0% { opacity: 0.9; } 50% { opacity: 1; } 100% { opacity: 0.9; } }
        .tv-screen::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(transparent, rgba(0,0,0,0.5)); pointer-events: none; }
        button { background-color: #222; color: lime; border: 1px solid lime; padding: 10px; cursor: pointer; box-shadow: 0 0 5px lime; }
        input { background-color: #111; color: lime; border: 1px solid lime; padding: 5px; width: 100%; }
        audio { margin: 5px 0; width: 100%; }
        a { color: lime; text-decoration: none; }
        .section { margin-top: 20px; }
        .archive-item { margin-bottom: 10px; border-bottom: 1px solid lime; padding-bottom: 5px; }
    </style>
</head>
<body>
    <div class="tv-frame">
        <div class="tv-screen" id="console"></div>
    </div>

    <div class="section">
        <h2>Générateur Pro</h2>
        <input type="text" id="prompt" value="reggae dub King tubby dela tape invasion" placeholder="Prompt (ex. reggae dub)">
        <button onclick="generateMusic()">Générer 2 Musiques</button>
        <div id="genResult"></div>
        <audio controls id="audio1"></audio>
        <a id="download1" href="" download>Download Musique 1</a>
        <audio controls id="audio2"></audio>
        <a id="download2" href="" download>Download Musique 2</a>
    </div>

    <div class="section">
        <h2>Récupérer & Archiver de Base44</h2>
        <input type="text" id="trackId" value="44" placeholder="Track ID (ex. 44)">
        <button onclick="retrieveAndArchive()">Récupérer & Archiver</button>
    </div>

    <div class="section">
        <h2>Archive Pro</h2>
        <div id="archive"></div>
    </div>

    <script>
        const API_URL = "https://undergroundstudioapp.netlify.app/generateAudio"; // Backend Netlify
        const BASE44_API_URL = "https://base44.app/api/apps/" + process.env.BASE44_APP_ID + "/entities/Track/"; // Backend Base44
        const BASE44_APP_ID = process.env.BASE44_APP_ID;
        const BASE44_API_KEY = process.env.BASE44_API_KEY;
        const consoleEl = document.getElementById('console');
        let archive = localStorage.getItem('archive') ? JSON.parse(localStorage.getItem('archive')) : [];

        function log(message) {
            consoleEl.innerHTML += `<p>${new Date().toLocaleTimeString()} - ${message}</p>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        async function generateMusic() {
            const prompt = document.getElementById('prompt').value;
            log("INIT: Vérification params... Prompt: " + prompt + ". Attente: Requête API Suno.");
            if (!prompt) { log("ERREUR: Prompt vide. Étape annulée."); return; }
            log("REQUETE: POST à " + API_URL + " pour musique 1.");
            try {
                const response1 = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${BASE44_API_KEY}` },
                    body: JSON.stringify({ prompt, trackId: "44", customMode: false, instrumental: true, model: "V3_5" })
                });
                log("REPONSE: Statut " + response1.status + ". Attente: Parsing JSON.");
                if (!response1.ok) { log("ERREUR: Statut " + response1.status + ". Étape échouée."); throw new Error(`Erreur 1: ${response1.status}`); }
                const data1 = await response1.json();
                log("SUCCES: taskId = " + data1.taskId + ". Audio URL: " + (data1.audio_url || "Non disponible") + ". Étape: Mise à jour player 1.");
                document.getElementById('audio1').src = data1.audio_url || "";
                document.getElementById('download1').href = data1.audio_url || "";
                archive.push({ id: "44", url: data1.audio_url || "", prompt });
                log("ARCHIVE: Ajouté musique 1. Attente: Requête musique 2.");

                log("REQUETE: POST à " + API_URL + " pour musique 2 variation.");
                const response2 = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${BASE44_API_KEY}` },
                    body: JSON.stringify({ prompt: prompt + " variation", trackId: "009", customMode: false, instrumental: true, model: "V3_5" })
                });
                log("REPONSE: Statut " + response2.status + ". Attente: Parsing JSON.");
                if (!response2.ok) { log("ERREUR: Statut " + response2.status + ". Étape échouée."); throw new Error(`Erreur 2: ${response2.status}`); }
                const data2 = await response2.json();
                log("SUCCES: taskId = " + data2.taskId + ". Audio URL: " + (data2.audio_url || "Non disponible") + ". Étape: Mise à jour player 2.");
                document.getElementById('audio2').src = data2.audio_url || "";
                document.getElementById('download2').href = data2.audio_url || "";
                archive.push({ id: "009", url: data2.audio_url || "", prompt: prompt + " variation" });
                log("ARCHIVE: Ajouté musique 2. Génération terminée.");

                updateArchive();
            } catch (error) {
                log("ERREUR GLOBALE: " + error.message + ". Requête échouée.");
            }
        }

        async function retrieveAndArchive() {
            const trackId = document.getElementById('trackId').value;
            log("INIT: Vérification params... Track ID: " + trackId + ". Attente: Requête Base44.");
            if (!trackId) { log("ERREUR: Track ID vide. Étape annulée."); return; }
            log("REQUETE: GET à " + BASE44_API_URL + trackId + " pour récupération.");
            try {
                const response = await fetch(BASE44_API_URL + trackId, {
                    headers: { "Authorization": `Bearer ${BASE44_API_KEY}` }
                });
                log("REPONSE: Statut " + response.status + ". Attente: Parsing JSON.");
                if (!response.ok) { log("ERREUR: Statut " + response.status + ". Étape échouée."); throw new Error(`Erreur récupération: ${response.status}`); }
                const data = await response.json();
                log("SUCCES: Audio URL = " + (data.audio_url || "Non disponible") + ". Étape: Mise à jour archive.");
                archive.push({ id: trackId, url: data.audio_url || "", prompt: data.prompt || "" });
                log("ARCHIVE: Ajouté track " + trackId + ". Récupération terminée.");
                updateArchive();
            } catch (error) {
                log("ERREUR GLOBALE: " + error.message + ". Requête échouée.");
            }
        }

        function updateArchive() {
            const archiveDiv = document.getElementById('archive');
            archiveDiv.innerHTML = archive.map(item => `
                <div class="archive-item">Track ${item.id} (${item.prompt})
                    <audio controls src="${item.url}"></audio>
                    <a href="${item.url}" download="track_${item.id}.mp3">Download</a>
                </div>
            `).join('');
            localStorage.setItem('archive', JSON.stringify(archive));
            log("ARCHIVE: Mise à jour effectuée.");
        }
        updateArchive(); // Charge archive initiale
        log("CONSOLE: Système prêt. Aucune erreur au démarrage. Attente action utilisateur.");
    </script>
</body>
</html>